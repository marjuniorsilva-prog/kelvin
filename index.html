<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot, getDoc, increment } 
    from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBbs5adc-5M46SujfgPpOYOHTjsncxce_8",
        authDomain: "kelvin-c16b4.firebaseapp.com",
        projectId: "kelvin-c16b4",
        storageBucket: "kelvin-c16b4.firebasestorage.app",
        messagingSenderId: "388075706958",
        appId: "1:388075706958:web:b2c631e8690cea14acc11f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 1. CADASTRAR PRODUTO ---
    document.getElementById('btn-salvar').addEventListener('click', async () => {
        try {
            const prod = {
                nome: document.getElementById('nome-prod').value,
                custo: Number(document.getElementById('custo-prod').value),
                venda: Number(document.getElementById('venda-prod').value),
                aluguel: Number(document.getElementById('aluguel-prod').value),
                qtd: Number(document.getElementById('qtd-prod').value)
            };
            await addDoc(collection(db, "estoque"), prod);
            alert("K.S SERVIÇO: Equipamento cadastrado com sucesso!");
            location.reload(); // Atualiza para limpar campos
        } catch (error) {
            console.error("Erro ao cadastrar:", error);
            alert("Erro ao salvar produto.");
        }
    });

    // --- 2. CARREGAR SELECT E ATUALIZAR ESTOQUE NA TELA ---
    let produtosMap = {}; // Para guardar os nomes dos produtos

    onSnapshot(collection(db, "estoque"), (snapshot) => {
        const select = document.getElementById('select-equipamento');
        select.innerHTML = '<option value="">Selecione...</option>';
        let totalItens = 0;

        snapshot.forEach(docSnap => {
            const item = docSnap.data();
            produtosMap[docSnap.id] = item; // Salva para usar depois
            select.innerHTML += `<option value="${docSnap.id}">${item.nome} (Disp: ${item.qtd})</option>`;
            totalItens += item.qtd;
        });
        document.getElementById('total-estoque').innerText = totalItens + " Unidades";
    });

    // --- 3. FINALIZAR VENDA OU ALUGUEL (COM BAIXA NO ESTOQUE) ---
    document.getElementById('btn-finalizar').addEventListener('click', async () => {
        const idProduto = document.getElementById('select-equipamento').value;
        const qtdAtual = produtosMap[idProduto].qtd;

        if (qtdAtual <= 0) {
            alert("ERRO: Produto sem estoque!");
            return;
        }

        const tipo = document.getElementById('tipo-operacao').value;
        const nomeProd = produtosMap[idProduto].nome; // Pega o nome certo

        const operacao = {
            cliente: document.getElementById('cliente-nome').value,
            tipo: tipo,
            taxaInstalacao: Number(document.getElementById('taxa-servico').value),
            dataCobranca: document.getElementById('data-cobranca').value,
            status: 'Ativo',
            equipamentoId: idProduto,
            equipamentoNome: nomeProd, // Salva o nome para mostrar na tabela
            valorContrato: tipo === 'venda' ? produtosMap[idProduto].venda : produtosMap[idProduto].aluguel,
            dataRegistro: new Date()
        };

        // Salva o contrato
        await addDoc(collection(db, "contratos"), operacao);

        // Abate do Estoque (-1)
        const produtoRef = doc(db, "estoque", idProduto);
        await updateDoc(produtoRef, {
            qtd: increment(-1)
        });

        alert("Operação registrada! Estoque atualizado.");
    });

    // --- 4. CARREGAR TABELA E SOMAR LUCROS ---
    onSnapshot(collection(db, "contratos"), (snapshot) => {
        const tabela = document.getElementById('tabela-ativos');
        tabela.innerHTML = '';
        
        let lucroVendas = 0;
        let receitaMensal = 0;

        snapshot.forEach(docSnap => {
            const res = docSnap.data();
            const id = docSnap.id;

            // Só soma se estiver ATIVO
            if (res.status === 'Ativo') {
                if (res.tipo === 'venda') {
                    // Lucro Venda = (Valor Venda + Instalação) - (Custo não temos aqui fácil, somamos faturamento bruto)
                    lucroVendas += (res.valorContrato + res.taxaInstalacao);
                } else {
                    receitaMensal += res.valorContrato;
                }
            }

            // Cria a linha da tabela
            const classeStatus = res.status === 'Ativo' ? 'success' : 'danger';
            const botaoAcao = res.status === 'Ativo' 
                ? `<button onclick="window.devolverItem('${id}', '${res.equipamentoId}')" style="background:#c0392b; padding:5px; font-size:12px;">Devolver/Cancelar</button>` 
                : '<span style="color:red;">Encerrado</span>';

            tabela.innerHTML += `
                <tr>
                    <td>${res.cliente}</td>
                    <td>${res.equipamentoNome || 'Equipamento'}</td>
                    <td><span class="badge ${res.tipo === 'venda' ? 'badge-venda' : 'badge-aluguel'}">${res.tipo.toUpperCase()}</span></td>
                    <td>Dia ${res.dataCobranca ? res.dataCobranca.slice(-2) : 'N/A'}</td>
                    <td style="font-weight:bold;">${res.status}</td>
                    <td>${botaoAcao}</td>
                </tr>
            `;
        });

        // Atualiza os Cards de Dinheiro
        document.getElementById('lucro-total').innerText = "R$ " + lucroVendas.toFixed(2);
        document.getElementById('recorrencia').innerText = "R$ " + receitaMensal.toFixed(2);
    });

    // --- 5. FUNÇÃO DE DEVOLUÇÃO (VOLTA PRO ESTOQUE) ---
    // Precisamos expor essa função para o HTML global
    window.devolverItem = async (idContrato, idProduto) => {
        if(confirm("Confirmar devolução? O item voltará ao estoque e a cobrança vai parar.")) {
            // 1. Muda status do contrato para Encerrado
            const contratoRef = doc(db, "contratos", idContrato);
            await updateDoc(contratoRef, { status: "Devolvido/Encerrado" });

            // 2. Devolve item pro estoque (+1)
            const produtoRef = doc(db, "estoque", idProduto);
            await updateDoc(produtoRef, { qtd: increment(1) });

            alert("Contrato cancelado e estoque reposto!");
        }
    };

</script>
