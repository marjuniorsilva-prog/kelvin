<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA KELVIN v2.5 PRO</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --bg-body: #f4f7f9; --sidebar-color: #1a1a27; --brand-cyan: #00d2ff; }
        body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; }
        .sidebar { background-color: var(--sidebar-color); min-height: 100vh; padding: 0; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .sidebar-btn { width: 100%; border: none; background: transparent; color: #a2a3b7; padding: 15px 25px; text-align: left; transition: 0.3s; display: flex; align-items: center; text-decoration: none; font-size: 0.9rem; }
        .sidebar-btn i { width: 25px; margin-right: 10px; }
        .sidebar-btn:hover, .sidebar-btn.active { color: #fff; background: rgba(255,255,255,0.05); }
        .sidebar-btn.active { color: var(--brand-cyan); border-right: 4px solid var(--brand-cyan); font-weight: 600; }
        .mobile-header { background: var(--sidebar-color); padding: 15px; color: white; position: sticky; top: 0; z-index: 1050; display: none; }
        @media (max-width: 768px) { .sidebar { display: none; } .mobile-header { display: flex; justify-content: space-between; align-items: center; } }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--sidebar-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="login-screen">
    <div class="card p-5 text-center shadow-lg" style="width: 350px;">
        <h3 class="fw-bold mb-4">KELVIN <span style="color:var(--brand-cyan)">PRO</span></h3>
        <input type="password" id="loginPass" class="form-control mb-3 text-center" placeholder="Senha">
        <button onclick="fazerLogin()" class="btn btn-dark w-100">ENTRAR</button>
    </div>
</div>

<div class="mobile-header d-md-none" id="mobile-top-bar" style="display:none;">
    <span class="fw-bold">KELVIN <span style="color:var(--brand-cyan)">SYS</span></span>
    <button class="btn border-0 p-0 text-white" type="button" data-bs-toggle="collapse" data-bs-target="#menuMobile">
        <i class="fas fa-bars fa-lg"></i>
    </button>
</div>

<div class="collapse d-md-none bg-dark" id="menuMobile">
    <button class="sidebar-btn" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</button>
    <button class="sidebar-btn" onclick="nav('clientes', this)"><i class="fas fa-users"></i> Clientes</button>
    <button class="sidebar-btn" onclick="nav('orcamento', this)"><i class="fas fa-file-invoice"></i> Orçamentos</button>
    <button class="sidebar-btn" onclick="nav('estoque', this)"><i class="fas fa-boxes"></i> Estoque</button>
    <button class="sidebar-btn" onclick="nav('financeiro', this)"><i class="fas fa-wallet"></i> Financeiro</button>
</div>

<div id="app-content" class="container-fluid d-none">
    <div class="row">
        <div class="col-md-2 sidebar sticky-top d-none d-md-block">
            <div class="p-4 text-center border-bottom border-secondary mb-3">
                <h5 class="text-white fw-bold">KELVIN <span style="color:var(--brand-cyan)">SYS</span></h5>
            </div>
            <button class="sidebar-btn active" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="sidebar-btn" onclick="nav('clientes', this)"><i class="fas fa-users"></i> Clientes</button>
            <button class="sidebar-btn" onclick="nav('orcamento', this)"><i class="fas fa-file-invoice"></i> Orçamentos</button>
            <button class="sidebar-btn" onclick="nav('estoque', this)"><i class="fas fa-boxes"></i> Estoque</button>
            <button class="sidebar-btn" onclick="nav('financeiro', this)"><i class="fas fa-wallet"></i> Financeiro</button>
        </div>

        <div class="col-md-10 p-4">
            <div id="page-dashboard" class="page-section">
                <h4 class="fw-bold mb-4">Resultados</h4>
                <div class="row g-3">
                    <div class="col-md-3"><div class="card p-4"><span>BRUTO</span><h3 class="text-success" id="dashBruto">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card p-4"><span>LUCRO REAL</span><h3 class="text-info" id="dashLucro">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card p-4"><span>VENCIDO</span><h3 class="text-danger" id="dashVencido">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card p-4"><span>FUTURO</span><h3 class="text-primary" id="dashFuturo">R$ 0,00</h3></div></div>
                </div>
            </div>

            <div id="page-clientes" class="page-section d-none">
                <div class="card p-4">
                    <h5 class="fw-bold mb-3">Novo Cliente</h5>
                    <div class="row g-2">
                        <div class="col-md-6"><label class="small fw-bold">Nome / Razão Social</label><input type="text" id="cliNome" class="form-control"></div>
                        <div class="col-md-6"><label class="small fw-bold">CPF / CNPJ</label><input type="text" id="cliDoc" class="form-control"></div>
                        <div class="col-md-3"><label class="small fw-bold">CEP</label><input type="text" id="cliCep" class="form-control" onblur="buscarCep()"></div>
                        <div class="col-md-7"><label class="small fw-bold">Rua</label><input type="text" id="cliRua" class="form-control" readonly></div>
                        <div class="col-md-2"><label class="small fw-bold">Nº</label><input type="text" id="cliNum" class="form-control"></div>
                        <div class="col-12 text-end mt-3"><button onclick="salvarCliente()" class="btn btn-primary">SALVAR</button></div>
                    </div>
                </div>
                <div class="card p-3"><table class="table"><tbody id="listaClientes"></tbody></table></div>
            </div>

            <div id="page-estoque" class="page-section d-none">
                <div class="card p-4">
                    <h5 class="fw-bold mb-3">Cadastrar Item</h5>
                    <div class="row g-2">
                        <div class="col-md-6"><input type="text" id="prodNome" class="form-control" placeholder="Nome"></div>
                        <div class="col-md-2"><input type="number" id="prodCusto" class="form-control" placeholder="Custo"></div>
                        <div class="col-md-2"><input type="number" id="prodVenda" class="form-control" placeholder="Venda"></div>
                        <div class="col-md-2"><input type="number" id="prodQtd" class="form-control" placeholder="Qtd"></div>
                        <div class="col-12 text-end mt-2"><button onclick="salvarProduto()" class="btn btn-dark">CADASTRAR</button></div>
                    </div>
                </div>
                <div class="card p-3"><table class="table"><thead class="table-light"><tr><th>Item</th><th>Venda</th><th>Estoque</th><th>Ação</th></tr></thead><tbody id="tabelaEstoque"></tbody></table></div>
            </div>

            <div id="page-orcamento" class="page-section d-none">
                <ul class="nav nav-pills mb-3">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-novo">Novo</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-pend" onclick="renderHistoricoOrcamentos()">Pendentes</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-novo">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card p-3">
                                    <label class="small fw-bold">Cliente</label><select id="selCliente" class="form-select mb-2"></select>
                                    <label class="small fw-bold">Tipo</label><select id="tipoContrato" class="form-select mb-2" onchange="toggleMensalidade()"><option value="VENDA">Venda</option><option value="ALUGUEL">Aluguel</option></select>
                                    <div id="boxMensalidade" class="d-none bg-light p-2 mb-2"><label class="small fw-bold">Mensal</label><input type="number" id="valorMensal" class="form-control" oninput="atualizaTotalDisplay()"><input type="date" id="dataVenc" class="form-control mt-1"></div>
                                    <hr>
                                    <label class="small fw-bold">Produto</label><select id="selProdOrc" class="form-select mb-2" onchange="preencherPreco()"></select>
                                    <div class="row g-1">
                                        <div class="col-4"><input type="number" id="qtdItem" class="form-control" value="1"></div>
                                        <div class="col-5"><input type="number" id="precoItem" class="form-control"></div>
                                        <div class="col-3"><button onclick="addCarrinho()" class="btn btn-primary w-100">+</button></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8"><div class="card p-3"><h5 id="displayTotal" class="fw-bold">R$ 0,00</h5><table class="table"><tbody id="tabelaCarrinho"></tbody></table><button onclick="salvarOrcamento()" class="btn btn-warning w-100 fw-bold">SALVAR</button></div></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab-pend"><div class="card p-3"><table class="table"><tbody id="listaOrcamentos"></tbody></table></div></div>
                </div>
            </div>

            <div id="page-financeiro" class="page-section d-none">
                <div class="card p-4 d-flex flex-row justify-content-between">
                    <input type="month" id="filtroMes" class="form-control w-auto" onchange="renderFinanceiro()">
                    <button onclick="gerarFaturasDoMesSelecionado()" class="btn btn-primary">GERAR MÊS</button>
                </div>
                <div class="card p-3"><table class="table"><tbody id="listaFaturas"></tbody></table></div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalEntrada" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Entrada</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 id="modalProdNome"></h6><input type="hidden" id="modalProdId"><input type="number" id="modalQtdEntrada" class="form-control" placeholder="Qtd"></div><div class="modal-footer"><button onclick="confirmarEntrada()" class="btn btn-success w-100">Confirmar</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DB = {
        clientes: JSON.parse(localStorage.getItem('kp25_clientes')) || [],
        produtos: JSON.parse(localStorage.getItem('kp25_produtos')) || [],
        orcamentos: JSON.parse(localStorage.getItem('kp25_orcamentos')) || [],
        contratos: JSON.parse(localStorage.getItem('kp25_contratos')) || [],
        faturas: JSON.parse(localStorage.getItem('kp25_faturas')) || []
    };
    function saveDB() { Object.keys(DB).forEach(k => localStorage.setItem('kp25_'+k, JSON.stringify(DB[k]))); }
    function showToast(msg, type='info') { const t = document.createElement('div'); t.className = `alert alert-${type} py-2 px-4 mb-2 shadow-lg`; t.innerText = msg; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000); }
    function fazerLogin() { if(document.getElementById('loginPass').value==='1234'){ document.getElementById('login-screen').classList.add('d-none'); document.getElementById('app-content').classList.remove('d-none'); document.getElementById('mobile-top-bar').style.display='flex'; initSystem(); } }
    
    function nav(p, btn) {
        document.querySelectorAll('.page-section').forEach(el=>el.classList.add('d-none'));
        document.getElementById('page-'+p).classList.remove('d-none');
        document.querySelectorAll('.sidebar-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        const menu = document.getElementById('menuMobile');
        const bsCollapse = bootstrap.Collapse.getInstance(menu);
        if (bsCollapse) bsCollapse.hide();
        if(p==='dashboard') updateDashboard();
        if(p==='financeiro') renderFinanceiro();
        if(p==='clientes') renderClientes();
        if(p==='estoque') renderEstoque();
    }

    // --- CORREÇÃO DO BOTÃO ADICIONAR ITEM ---
    let carrinho = [];
    function addCarrinho() {
        const sel = document.getElementById('selProdOrc');
        const pid = parseInt(sel.value);
        const p = DB.produtos.find(x => x.id === pid);
        const vEdit = parseFloat(document.getElementById('precoItem').value);
        const qtd = parseInt(document.getElementById('qtdItem').value);

        if (p && !isNaN(vEdit) && qtd > 0) {
            carrinho.push({ ...p, venda: vEdit, qtdCarrinho: qtd });
            renderCarrinho();
            showToast('Adicionado!');
        } else {
            showToast('Selecione o produto e o preço', 'warning');
        }
    }

    function renderCarrinho() {
        const tb = document.getElementById('tabelaCarrinho'); tb.innerHTML = '';
        carrinho.forEach((i, idx) => {
            tb.innerHTML += `<tr><td>${i.nome}</td><td>${i.qtdCarrinho}x</td><td>R$ ${i.venda}</td><td><button onclick="carrinho.splice(${idx},1);renderCarrinho()" class="btn btn-sm text-danger">x</button></td></tr>`;
        });
        atualizaTotalDisplay();
    }

    function atualizaTotalDisplay() {
        const tipo = document.getElementById('tipoContrato').value;
        let t = 0; carrinho.forEach(i => t += i.venda * i.qtdCarrinho);
        document.getElementById('displayTotal').innerText = (tipo === 'VENDA') ? `Total: R$ ${t.toFixed(2)}` : `Mensal: R$ ${parseFloat(document.getElementById('valorMensal').value || 0).toFixed(2)}`;
    }

    // --- ESTOQUE ---
    function salvarProduto() {
        DB.produtos.push({id:Date.now(), nome:document.getElementById('prodNome').value, custo:parseFloat(document.getElementById('prodCusto').value)||0, venda:parseFloat(document.getElementById('prodVenda').value)||0, qtd:parseInt(document.getElementById('prodQtd').value)||0, tipo:'PRODUTO'});
        saveDB(); renderEstoque(); showToast('Cadastrado!');
    }
    function renderEstoque() {
        const tb=document.getElementById('tabelaEstoque'); const sel=document.getElementById('selProdOrc');
        tb.innerHTML=''; sel.innerHTML='<option value="">Selecione...</option>';
        DB.produtos.forEach(p => {
            tb.innerHTML+=`<tr><td>${p.nome}</td><td>R$ ${p.venda}</td><td>${p.qtd}</td><td><button onclick="abrirModalEntrada(${p.id})" class="btn btn-sm btn-success">+</button></td></tr>`;
            sel.innerHTML+=`<option value="${p.id}" data-preco="${p.venda}">${p.nome}</option>`;
        });
    }
    function abrirModalEntrada(id) { const p = DB.produtos.find(x => x.id === id); document.getElementById('modalProdId').value = id; document.getElementById('modalProdNome').innerText = p.nome; new bootstrap.Modal(document.getElementById('modalEntrada')).show(); }
    function confirmarEntrada() { const id = parseInt(document.getElementById('modalProdId').value); const qtd = parseInt(document.getElementById('modalQtdEntrada').value); const p = DB.produtos.find(x => x.id === id); if(p && qtd > 0) { p.qtd += qtd; saveDB(); renderEstoque(); showToast('Entrada OK!'); } bootstrap.Modal.getInstance(document.getElementById('modalEntrada')).hide(); }

    // --- CLIENTES ---
    async function buscarCep() { let cep = document.getElementById('cliCep').value.replace(/\D/g,''); if(cep.length===8){ const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`); const d = await r.json(); if(!d.erro){ document.getElementById('cliRua').value = d.logradouro; document.getElementById('cliNum').focus(); } } }
    function salvarCliente() { DB.clientes.push({id: Date.now(), nome: document.getElementById('cliNome').value, tel: '', rua: document.getElementById('cliRua').value, num: document.getElementById('cliNum').value}); saveDB(); renderClientes(); showToast('Cliente Salvo!'); }
    function renderClientes() { const tb=document.getElementById('listaClientes'); const sel=document.getElementById('selCliente'); tb.innerHTML=''; sel.innerHTML='<option value="">Selecione...</option>'; DB.clientes.forEach(c=>{ tb.innerHTML+=`<tr><td>${c.nome}</td><td>${c.rua}</td></tr>`; sel.innerHTML+=`<option value="${c.id}">${c.nome}</option>`; }); }

    // --- ORÇAMENTOS E FINANCEIRO ---
    function toggleMensalidade(){ const t=document.getElementById('tipoContrato').value; document.getElementById('boxMensalidade').classList.toggle('d-none', t==='VENDA'); atualizaTotalDisplay(); }
    function preencherPreco(){ const s=document.getElementById('selProdOrc'); const p = DB.produtos.find(x=>x.id==s.value); if(p) document.getElementById('precoItem').value = p.venda; }
    function salvarOrcamento() { const cid=parseInt(document.getElementById('selCliente').value); if(!cid) return showToast('Selecione Cliente'); const tipo=document.getElementById('tipoContrato').value; const val = (tipo==='VENDA') ? carrinho.reduce((a,b)=>a+(b.venda*b.qtdCarrinho),0) : parseFloat(document.getElementById('valorMensal').value); DB.orcamentos.push({id:Date.now(), clienteNome:DB.clientes.find(c=>c.id===cid).nome, tipo:tipo, itens:[...carrinho], valorFinal:val, status:'PENDENTE'}); saveDB(); carrinho=[]; renderCarrinho(); showToast('Salvo em Pendentes'); }
    function renderHistoricoOrcamentos() { const tb=document.getElementById('listaOrcamentos'); tb.innerHTML=''; DB.orcamentos.forEach(o=>{ if(o.status==='PENDENTE') tb.innerHTML+=`<tr><td>${o.clienteNome}<br><small>${o.tipo}</small></td><td>R$ ${o.valorFinal}</td><td><button onclick="aprovarOrcamento(${o.id})" class="btn btn-sm btn-success">Aprovar</button></td></tr>`; }); }
    function aprovarOrcamento(id) { const o=DB.orcamentos.find(x=>x.id===id); o.status='APROVADO'; if(o.tipo==='VENDA'){ DB.faturas.push({id:Date.now(), clienteNome:o.clienteNome, valor:o.valorFinal, vencimentoIso:new Date().toISOString().split('T')[0], status:'ABERTO', itens:o.itens}); } else { DB.contratos.push({...o, status:'ATIVO'}); } o.itens.forEach(i=>{const p=DB.produtos.find(x=>x.id===i.id); if(p)p.qtd-=i.qtdCarrinho;}); saveDB(); renderHistoricoOrcamentos(); showToast('Aprovado!'); }
    function renderFinanceiro() { const tb=document.getElementById('listaFaturas'); tb.innerHTML=''; const m=document.getElementById('filtroMes').value; DB.faturas.forEach(f=>{ if(m && !f.vencimentoIso.startsWith(m)) return; const btn = f.status==='ABERTO' ? `<button onclick="darBaixa(${f.id})" class="btn btn-sm btn-success">Receber</button>` : 'PAGO'; tb.innerHTML+=`<tr><td>${f.vencimentoIso}</td><td>${f.clienteNome}</td><td>R$ ${f.valor}</td><td>${btn}</td></tr>`; }); }
    function darBaixa(id){ const f=DB.faturas.find(x=>x.id==id); f.status='PAGO'; saveDB(); renderFinanceiro(); updateDashboard(); }
    function updateDashboard(){ const h=new Date().toISOString().split('T')[0]; let b=0, l=0, v=0, f=0; DB.faturas.forEach(x=>{ if(x.status==='PAGO'){ b+=x.valor; let c=0; if(x.itens) x.itens.forEach(i=>c+=(i.custo*i.qtdCarrinho)); l+=(x.valor-c); } else if(x.vencimentoIso<h) v+=x.valor; else f+=x.valor; }); document.getElementById('dashBruto').innerText=`R$ ${b.toFixed(2)}`; document.getElementById('dashLucro').innerText=`R$ ${l.toFixed(2)}`; document.getElementById('dashVencido').innerText=`R$ ${v.toFixed(2)}`; document.getElementById('dashFuturo').innerText=`R$ ${f.toFixed(2)}`; }
    function initSystem(){ const h=new Date(); document.getElementById('filtroMes').value=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,'0')}`; renderEstoque(); renderClientes(); updateDashboard(); }
</script>
</body>
</html>
