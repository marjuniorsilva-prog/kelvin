<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA KELVIN v2.4 PRO</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --bg-body: #f4f7f9; --sidebar-color: #1a1a27; --brand-cyan: #00d2ff; }
        body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; }
        .sidebar { background-color: var(--sidebar-color); min-height: 100vh; padding: 0; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .sidebar-btn { width: 100%; border: none; background: transparent; color: #a2a3b7; padding: 15px 25px; text-align: left; transition: 0.3s; display: flex; align-items: center; text-decoration: none; }
        .sidebar-btn:hover, .sidebar-btn.active { color: #fff; background: rgba(255,255,255,0.05); }
        .sidebar-btn.active { color: var(--brand-cyan); border-right: 4px solid var(--brand-cyan); font-weight: 600; }
        .mobile-header { background: var(--sidebar-color); padding: 15px; color: white; position: sticky; top: 0; z-index: 1050; display: none; }
        @media (max-width: 768px) { .sidebar { display: none; } .mobile-header { display: flex; justify-content: space-between; align-items: center; } }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--sidebar-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="login-screen">
    <div class="card p-5 text-center shadow-lg" style="width: 350px;">
        <h3 class="fw-bold mb-4">KELVIN <span style="color:var(--brand-cyan)">PRO</span></h3>
        <input type="password" id="loginPass" class="form-control mb-3 text-center" placeholder="Senha">
        <button onclick="fazerLogin()" class="btn btn-dark w-100">ENTRAR</button>
    </div>
</div>

<div class="mobile-header d-md-none" id="mobile-top-bar">
    <span class="fw-bold">KELVIN <span style="color:var(--brand-cyan)">SYS</span></span>
    <button class="btn border-0 p-0 text-white" type="button" data-bs-toggle="collapse" data-bs-target="#menuMobile">
        <i class="fas fa-bars fa-lg"></i>
    </button>
</div>

<div class="collapse d-md-none" id="menuMobile">
    <div class="bg-dark">
        <button class="sidebar-btn" onclick="nav('dashboard', this)">Dashboard</button>
        <button class="sidebar-btn" onclick="nav('clientes', this)">Clientes</button>
        <button class="sidebar-btn" onclick="nav('orcamento', this)">Orçamentos</button>
        <button class="sidebar-btn" onclick="nav('contratos', this)">Contratos</button>
        <button class="sidebar-btn" onclick="nav('estoque', this)">Estoque</button>
        <button class="sidebar-btn" onclick="nav('financeiro', this)">Financeiro</button>
    </div>
</div>

<div id="app-content" class="container-fluid d-none">
    <div class="row">
        <div class="col-md-2 sidebar sticky-top d-none d-md-block">
            <div class="p-4 text-center border-bottom border-secondary mb-3">
                <h5 class="text-white fw-bold mb-0">KELVIN <span style="color:var(--brand-cyan)">SYS</span></h5>
            </div>
            <button class="sidebar-btn active" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="sidebar-btn" onclick="nav('clientes', this)"><i class="fas fa-users"></i> Clientes</button>
            <button class="sidebar-btn" onclick="nav('orcamento', this)"><i class="fas fa-file-invoice"></i> Orçamentos</button>
            <button class="sidebar-btn" onclick="nav('contratos', this)"><i class="fas fa-handshake"></i> Contratos</button>
            <button class="sidebar-btn" onclick="nav('estoque', this)"><i class="fas fa-boxes"></i> Estoque</button>
            <button class="sidebar-btn" onclick="nav('financeiro', this)"><i class="fas fa-wallet"></i> Financeiro</button>
        </div>

        <div class="col-md-10 p-4">
            <div id="page-dashboard" class="page-section">
                <h4 class="fw-bold mb-4">Dashboard</h4>
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="card p-4"><span>BRUTO</span><h3 class="text-success" id="dashBruto">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card p-4"><span>LUCRO</span><h3 class="text-info" id="dashLucro">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card p-4"><span>VENCIDO</span><h3 class="text-danger" id="dashVencidoc">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card p-4"><span>FUTURO</span><h3 class="text-primary" id="dashFuturo">R$ 0,00</h3></div></div>
                </div>
            </div>

            <div id="page-orcamento" class="page-section d-none">
                <ul class="nav nav-pills mb-3">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-novo">Criar</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-pend" onclick="renderHistoricoOrcamentos()">Pendentes</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-novo">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card p-3">
                                    <label class="small fw-bold">Cliente</label><select id="selCliente" class="form-select mb-2"></select>
                                    <label class="small fw-bold">Tipo</label><select id="tipoContrato" class="form-select mb-2" onchange="toggleMensalidade()"><option value="VENDA">Venda</option><option value="ALUGUEL">Aluguel</option><option value="STREAMING">Streaming</option></select>
                                    <div id="boxMensalidade" class="d-none bg-light p-2 mb-2"><input type="number" id="valorMensal" class="form-control mb-1" placeholder="Mensal" oninput="atualizaTotalDisplay()"><input type="date" id="dataPrimeiroVenc" class="form-control"></div>
                                    <hr>
                                    <label class="small fw-bold">Peça/Serviço</label><select id="selProdOrc" class="form-select mb-2" onchange="preencherPreco()"></select>
                                    <div class="row g-1">
                                        <div class="col-4"><input type="number" id="qtdItem" class="form-control" value="1"></div>
                                        <div class="col-5"><input type="number" id="precoItem" class="form-control" placeholder="Preço"></div>
                                        <div class="col-3"><button onclick="addCarrinho()" class="btn btn-primary w-100">Add</button></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8"><div class="card p-3"><h5 id="displayTotal" class="fw-bold text-primary">Total: R$ 0,00</h5><table class="table"><tbody id="tabelaCarrinho"></tbody></table><button onclick="salvarOrcamento()" class="btn btn-warning w-100 fw-bold mt-2">SALVAR ORÇAMENTO</button></div></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab-pend"><div class="card p-0 overflow-hidden"><table class="table mb-0"><tbody id="listaOrcamentos"></tbody></table></div></div>
                </div>
            </div>

            <div id="page-clientes" class="page-section d-none">...</div>
             <div id="page-estoque" class="page-section d-none">...</div>
             <div id="page-financeiro" class="page-section d-none">...</div>
             <div id="page-contratos" class="page-section d-none">...</div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // DB e Funções Base permanecem iguais
    const DB = {
        clientes: JSON.parse(localStorage.getItem('kp24_clientes')) || [],
        produtos: JSON.parse(localStorage.getItem('kp24_produtos')) || [],
        orcamentos: JSON.parse(localStorage.getItem('kp24_orcamentos')) || [],
        contratos: JSON.parse(localStorage.getItem('kp24_contratos')) || [],
        faturas: JSON.parse(localStorage.getItem('kp24_faturas')) || []
    };
    function saveDB() { Object.keys(DB).forEach(k => localStorage.setItem('kp24_'+k, JSON.stringify(DB[k]))); }
    function showToast(msg, type='info') { const t = document.createElement('div'); t.className = `alert alert-${type} py-2 px-4 mb-2 shadow-lg`; t.innerText = msg; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000); }
    function fazerLogin() { if(document.getElementById('loginPass').value==='1234'){ document.getElementById('login-screen').classList.add('d-none'); document.getElementById('app-content').classList.remove('d-none'); document.getElementById('mobile-top-bar').style.display='flex'; initSystem(); } }
    
    function nav(p, btn) {
        document.querySelectorAll('.page-section').forEach(el=>el.classList.add('d-none'));
        document.getElementById('page-'+p).classList.remove('d-none');
        document.querySelectorAll('.sidebar-btn').forEach(b=>b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        const menu = document.getElementById('menuMobile');
        const bsCollapse = bootstrap.Collapse.getInstance(menu);
        if (bsCollapse) bsCollapse.hide();
        if(p==='dashboard') updateDashboard();
        if(p==='financeiro') renderFinanceiro();
        if(p==='contratos') renderContratosAtivos();
        if(p==='clientes') renderClientes();
        if(p==='estoque') renderEstoque();
    }

    // --- CORREÇÃO DO BOTÃO ADICIONAR ---
    function addCarrinho(){ 
        const sel = document.getElementById('selProdOrc');
        const pid = parseInt(sel.value); 
        const p = DB.produtos.find(x => x.id === pid); 
        const vEdit = parseFloat(document.getElementById('precoItem').value);
        const qtd = parseInt(document.getElementById('qtdItem').value);

        if(p && !isNaN(vEdit)){ 
            carrinho.push({
                ...p, 
                venda: vEdit, 
                qtdCarrinho: qtd
            }); 
            renderCarrinho(); 
            showToast('Item adicionado!');
        } else {
            showToast('Selecione um produto e preço', 'warning');
        }
    }

    // Funções de preencher preço e render carrinho seguem
    function preencherPreco(){ const s = document.getElementById('selProdOrc'); const p = DB.produtos.find(x=>x.id == s.value); if(p) document.getElementById('precoItem').value = p.venda; }
    function renderCarrinho(){ const tb=document.getElementById('tabelaCarrinho'); tb.innerHTML=''; let t=0; carrinho.forEach((i,idx)=>{t+=i.venda*i.qtdCarrinho; tb.innerHTML+=`<tr><td>${i.nome}</td><td>${i.qtdCarrinho}x</td><td>R$ ${i.venda}</td><td><button onclick="carrinho.splice(${idx},1);renderCarrinho()" class="btn btn-sm text-danger">x</button></td></tr>`;}); atualizaTotalDisplay();}
    function atualizaTotalDisplay(){ const tipo=document.getElementById('tipoContrato').value; let t=0; carrinho.forEach(i=>t+=i.venda*i.qtdCarrinho); document.getElementById('displayTotal').innerText = (tipo==='VENDA') ? `Total: R$ ${t.toFixed(2)}` : `Mensal: R$ ${parseFloat(document.getElementById('valorMensal').value || 0).toFixed(2)}`; }
    
    // ... RESTANTE DO CÓDIGO (PRODUTOS, CLIENTES, FINANCEIRO) MANTIDO ...

    function initSystem(){ const h=new Date(); document.getElementById('filtroMes').value=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,'0')}`; renderEstoque(); renderClientes(); updateDashboard(); }
</script>
</body>
</html>
