<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.S SERVIÇO | Gestão Financeira Blindada</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #0f172a; --secondary: #1e293b; --accent: #f59e0b;
            --text: #f8fafc; --success: #22c55e; --danger: #ef4444; --info: #3b82f6;
            --border: #334155; --pending: #eab308;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Roboto', sans-serif; }
        body { background: var(--primary); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        aside { width: 260px; background: var(--secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .brand { padding: 30px; text-align: center; color: var(--accent); font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid var(--border); }
        .menu-item { padding: 15px 25px; cursor: pointer; color: #94a3b8; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: rgba(245, 158, 11, 0.1); color: var(--accent); border-right: 4px solid var(--accent); }

        /* MAIN */
        main { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .panel { background: var(--secondary); padding: 25px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 25px; }
        h2 { color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2rem; }

        /* FORMS */
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; } .col-small { width: 120px; }
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #94a3b8; }
        input, select { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--border); color: white; border-radius: 6px; }
        
        /* TABLE & BADGES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; }
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color:white; display: inline-block;}
        .bg-pendente { background: var(--pending); color: black; }
        .bg-pago { background: var(--success); }
        .bg-vencido { background: var(--danger); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* BUTTONS */
        button { padding: 12px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-gold { background: var(--accent); color: #000; width: 100%; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-blue { background: var(--info); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--secondary); padding: 30px; border-radius: 10px; width: 400px; border: 1px solid var(--accent); }
    </style>
</head>
<body>

    <div id="modal-baixa" class="modal-overlay">
        <div class="modal-box">
            <h2 style="text-align:center">Confirmar Recebimento</h2>
            <p id="baixa-desc" style="text-align:center; color:#ccc; margin-bottom:20px;">...</p>
            
            <label>Data que o dinheiro entrou:</label>
            <input type="date" id="baixa-data">
            
            <button class="btn-green" style="width:100%; margin-top:20px;" onclick="confirmarBaixa()">CONFIRMAR PAGAMENTO</button>
            <button class="btn-red" style="width:100%; margin-top:10px;" onclick="fecharModalBaixa()">CANCELAR</button>
        </div>
    </div>

    <aside>
        <div class="brand"><i class="fa-solid fa-shield-halved"></i> K.S SERVIÇO</div>
        <div class="menu-item active" onclick="nav('orcamentos')"><i class="fa-solid fa-file-invoice"></i> Novo Orçamento</div>
        <div class="menu-item" onclick="nav('receber')"><i class="fa-solid fa-calendar-check"></i> Contas a Receber</div>
        <div class="menu-item" onclick="nav('inadimplentes')"><i class="fa-solid fa-triangle-exclamation" style="color:red"></i> Devedores (Atrasados)</div>
        <div class="menu-item" onclick="nav('historico')"><i class="fa-solid fa-clock-rotate-left"></i> Histórico Completo</div>
        
        <div style="margin-top:auto; padding:20px; text-align:center; font-size:0.8rem; color:#888;">
            <a href="#" onclick="sair()" style="color:var(--danger)">Sair</a>
        </div>
    </aside>

    <main>

        <div id="orcamentos" class="section active">
            <div class="panel" style="border-top: 5px solid var(--accent);">
                <div style="display:flex; justify-content:space-between;">
                    <h2>Novo Pedido</h2>
                    <button class="btn-blue btn-sm" onclick="limparForm()">Limpar</button>
                </div>

                <div class="row">
                    <div class="col"><label>Cliente</label><input type="text" id="cli-nome"></div>
                    <div class="col"><label>Tipo</label><select id="cli-tipo"><option value="venda">Venda</option><option value="aluguel">Aluguel</option></select></div>
                </div>

                <div class="row" style="background:#0f172a; padding:15px; border-radius:8px; align-items:flex-end;">
                    <div class="col" style="flex:2"><label>Produto</label><select id="cart-sel"><option>Carregando...</option></select></div>
                    <div class="col-small"><label>Qtd</label><input type="number" id="cart-qtd" value="1"></div>
                    <div class="col-small"><button class="btn-blue" onclick="addCart()">+ Add</button></div>
                </div>
                <table style="margin-bottom:20px;">
                    <thead><tr><th>Item</th><th>Qtd</th><th>Unit.</th><th>Total</th></tr></thead>
                    <tbody id="cart-body"></tbody>
                </table>

                <div class="row">
                    <div class="col"><label>Mão de Obra (R$)</label><input type="number" id="cli-serv" value="0" onchange="calcTotal()"></div>
                    <div class="col" style="text-align:right;"><h1 id="total-display" style="color:var(--success)">R$ 0,00</h1></div>
                </div>

                <div class="row">
                    <button class="btn-gold col" onclick="aprovarVendaDireta()">FECHAR VENDA E GERAR FINANCEIRO</button>
                </div>
            </div>
        </div>

        <div id="receber" class="section">
            <div class="panel">
                <h2>Próximos Recebimentos</h2>
                <p style="color:#aaa;">Lista de tudo que está para vencer nos próximos dias.</p>
                <table id="tb-receber">
                    <thead><tr><th>Vencimento</th><th>Cliente</th><th>Valor</th><th>Status</th><th>Ação</th></tr></thead>
                    <tbody id="lista-receber"></tbody>
                </table>
            </div>
        </div>

        <div id="inadimplentes" class="section">
            <div class="panel" style="border-left: 5px solid red;">
                <h2 style="color:red"><i class="fa-solid fa-skull"></i> Clientes Inadimplentes (Atrasados)</h2>
                <p style="color:#aaa;">Estes clientes já passaram da data de vencimento. COBRE IMEDIATAMENTE!</p>
                <table id="tb-inadimplentes">
                    <thead><tr><th>Venceu em</th><th>Cliente</th><th>Valor</th><th>Dias Atraso</th><th>Ação</th></tr></thead>
                    <tbody id="lista-inadimplentes"></tbody>
                </table>
            </div>
        </div>

        <div id="historico" class="section">
            <div class="panel">
                <h2>Histórico de Pagamentos</h2>
                <div class="row">
                    <div class="col"><input type="text" id="busca-cli" placeholder="Buscar por Nome do Cliente..." onkeyup="filtrarHistorico()"></div>
                </div>
                <table id="tb-historico">
                    <thead><tr><th>Data Pagto</th><th>Vencimento</th><th>Cliente</th><th>Valor</th><th>Status</th></tr></thead>
                    <tbody id="lista-historico"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, increment, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbs5adc-5M46SujfgPpOYOHTjsncxce_8",
            authDomain: "kelvin-c16b4.firebaseapp.com",
            projectId: "kelvin-c16b4",
            storageBucket: "kelvin-c16b4.firebasestorage.app",
            messagingSenderId: "388075706958",
            appId: "1:388075706958:web:b2c631e8690cea14acc11f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let carrinho = [];
        let estoqueMap = {};
        let idBaixaAtual = null;

        // AUTH
        onAuthStateChanged(auth, u => { if(u) iniciar(); else signInWithPopup(auth, new GoogleAuthProvider()); });

        function iniciar() {
            // CARREGAR ESTOQUE
            onSnapshot(collection(db, "estoque"), (snap) => {
                const sel = document.getElementById('cart-sel');
                sel.innerHTML = '<option value="">Selecione...</option>';
                snap.forEach(d => {
                    const p = d.data();
                    estoqueMap[d.id] = p;
                    if(p.qtd > 0) sel.innerHTML += `<option value="${d.id}">${p.nome} (R$ ${p.venda})</option>`;
                });
            });

            // CARREGAR FINANCEIRO GERAL
            // Vamos carregar TUDO e filtrar no JS para separar as abas (A Receber, Atrasado, Histórico)
            const q = query(collection(db, "financeiro"), orderBy("vencimento", "asc"));
            onSnapshot(q, (snap) => {
                const tbReceber = document.getElementById('lista-receber');
                const tbInad = document.getElementById('lista-inadimplentes');
                const tbHist = document.getElementById('lista-historico');
                
                tbReceber.innerHTML = ''; tbInad.innerHTML = ''; tbHist.innerHTML = '';

                const hoje = new Date().toISOString().split('T')[0];

                snap.forEach(d => {
                    const f = d.data();
                    const id = d.id;
                    
                    // STATUS: Pendente, Pago
                    // CALCULANDO ATRASO
                    let isAtrasado = false;
                    let diasAtraso = 0;
                    
                    if(f.status === 'Pendente' && f.vencimento < hoje) {
                        isAtrasado = true;
                        const diff = new Date(hoje) - new Date(f.vencimento);
                        diasAtraso = Math.ceil(diff / (1000 * 60 * 60 * 24)); 
                    }

                    // HTML Comum
                    const btnBaixa = `<button class="btn-green btn-sm" onclick="abrirBaixa('${id}', '${f.descricao}', '${f.valor}')">RECEBER</button>`;
                    
                    // 1. ABA INADIMPLENTES (Atrasados)
                    if(isAtrasado) {
                        tbInad.innerHTML += `
                            <tr>
                                <td style="color:red; font-weight:bold">${f.vencimento}</td>
                                <td>${f.cliente}</td>
                                <td>R$ ${f.valor.toFixed(2)}</td>
                                <td><span class="badge bg-vencido">${diasAtraso} DIAS</span></td>
                                <td>${btnBaixa}</td>
                            </tr>
                        `;
                    }
                    
                    // 2. ABA A RECEBER (Pendente mas no prazo, ou hoje)
                    if(f.status === 'Pendente' && !isAtrasado) {
                        tbReceber.innerHTML += `
                            <tr>
                                <td>${f.vencimento}</td>
                                <td>${f.cliente}</td>
                                <td>R$ ${f.valor.toFixed(2)}</td>
                                <td><span class="badge bg-pendente">A VENCER</span></td>
                                <td>${btnBaixa}</td>
                            </tr>
                        `;
                    }

                    // 3. ABA HISTÓRICO (Tudo, inclusive pagos)
                    let statusBadge = '';
                    if(f.status === 'Pago') statusBadge = `<span class="badge bg-pago">PAGO EM ${f.dataPagamento}</span>`;
                    else if(isAtrasado) statusBadge = `<span class="badge bg-vencido">ATRASADO</span>`;
                    else statusBadge = `<span class="badge bg-pendente">ABERTO</span>`;

                    tbHist.innerHTML += `
                        <tr class="linha-hist" data-cli="${f.cliente.toLowerCase()}">
                            <td>${f.dataPagamento || '-'}</td>
                            <td>${f.vencimento}</td>
                            <td>${f.cliente}</td>
                            <td>R$ ${f.valor.toFixed(2)}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
            });
        }

        // --- VENDA SIMPLIFICADA COM FINANCEIRO ---
        window.aprovarVendaDireta = async () => {
            const cliente = document.getElementById('cli-nome').value;
            if(!cliente) return alert("Nome do cliente obrigatório");
            
            const total = (window.totalProd || 0) + Number(document.getElementById('cli-serv').value);
            const vencimento = prompt("Qual a data de vencimento desse boleto/pagamento?", new Date().toISOString().split('T')[0]);

            // 1. Baixar Estoque
            for(let i of carrinho) await updateDoc(doc(db, "estoque", i.id), { qtd: increment(-i.qtd) });

            // 2. Criar Conta a Receber
            await addDoc(collection(db, "financeiro"), {
                cliente: cliente,
                descricao: "Venda/Serviço",
                valor: total,
                vencimento: vencimento,
                status: 'Pendente',
                dataGeracao: new Date().toISOString().split('T')[0]
            });

            alert("Venda Registrada! Conta a Receber criada.");
            limparForm();
        };

        // --- BAIXA DE PAGAMENTO ---
        window.abrirBaixa = (id, desc, valor) => {
            idBaixaAtual = id;
            document.getElementById('baixa-desc').innerText = `${desc} - R$ ${valor}`;
            document.getElementById('baixa-data').valueAsDate = new Date();
            document.getElementById('modal-baixa').style.display = 'flex';
        };

        window.fecharModalBaixa = () => document.getElementById('modal-baixa').style.display = 'none';

        window.confirmarBaixa = async () => {
            const dataPag = document.getElementById('baixa-data').value;
            await updateDoc(doc(db, "financeiro", idBaixaAtual), {
                status: 'Pago',
                dataPagamento: dataPag
            });
            alert("Pagamento Confirmado! Dinheiro entrou no caixa.");
            fecharModalBaixa();
        };

        // --- UTILS ---
        window.addCart = () => {
            const id = document.getElementById('cart-sel').value;
            const qtd = Number(document.getElementById('cart-qtd').value);
            const p = estoqueMap[id];
            carrinho.push({ id, nome: p.nome, venda: p.venda, qtd, total: p.venda*qtd });
            renderCart();
        };

        function renderCart() {
            const tb = document.getElementById('cart-body');
            tb.innerHTML = '';
            let s = 0;
            carrinho.forEach(i => { s+=i.total; tb.innerHTML+=`<tr><td>${i.nome}</td><td>${i.qtd}</td><td>${i.venda}</td><td>${i.total}</td></tr>`; });
            window.totalProd = s;
            calcTotal();
        }

        window.calcTotal = () => {
            const s = Number(document.getElementById('cli-serv').value);
            document.getElementById('total-display').innerText = "R$ " + ((window.totalProd||0)+s).toFixed(2);
        };

        window.limparForm = () => { carrinho=[]; renderCart(); document.getElementById('cli-nome').value=''; };
        window.nav = (id) => { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); };
        
        window.filtrarHistorico = () => {
            const termo = document.getElementById('busca-cli').value.toLowerCase();
            document.querySelectorAll('.linha-hist').forEach(tr => {
                const cli = tr.getAttribute('data-cli');
                tr.style.display = cli.includes(termo) ? '' : 'none';
            });
        };
    </script>
</body>
</html>
